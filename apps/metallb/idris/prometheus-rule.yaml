apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: metallb-rules
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: LoadBalancer
      rules:
        - alert: MetalLBNoLeader
          expr: count(metallb_k8s_client_leadership_bool == 1) == 0
          for: 2m
          annotations:
            description: MetalLB has had no leader for the past 2 minutes.
            summary: MetalLB has no leader
        - alert: MetalLBConfigStale
          expr: metallb_k8s_client_config_stale_bool != 0
          for: 2m
          annotations:
            description: "{{ $labels.instance }}: MetalLB instance has stale configuration."
            summary: "{{ $labels.instance }}: MetalLB stale configuration."
        - alert: MetalLBNoUsableAddresses
          expr: metallb_allocator_addresses_total == 0
          annotations:
            description: "MetalLB has no usable addresses."
            summary: "MetalLB no usable address space."
        - alert: MetalLBUsableAddressUtilisation
          expr: "(sum((metallb_allocator_addresses_in_use_total / metallb_allocator_addresses_total)) by (pool) / count(metallb_allocator_addresses_in_use_total) by (pool) * 100) > 75"
          for: 2m
          annotations:
            description: "MetalLB usable address utilisation for IP pool {{ $labels.pool }} is currently at {{ $value }}%."
            summary: "MetalLB address space utilisation alert."
