apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: pihole
  name: pihole
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pihole
  template:
    metadata:
      labels:
        app: pihole
        name: pihole
    spec:
      containers:
        - name: exporter
          image: ekofr/pihole-exporter:v0.1.1
          imagePullPolicy: Always
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            runAsGroup: 65534
            readOnlyRootFilesystem: true
          env:
            - name: PIHOLE_HOSTNAME
              value: pihole
            - name: PIHOLE_API_TOKEN
              valueFrom:
                secretKeyRef:
                    key: api-token
                    name: pihole
        - name: pihole
          image: pihole/pihole:2022.01.1
          imagePullPolicy: Always
          securityContext:
            runAsNonRoot: false
            readOnlyRootFilesystem: false
          resources:
            requests:
              cpu: 100m
              memory: 32Mi
            limits:
              cpu: 500m
              memory: 128Mi
          env:
            - name: TZ
              value: "Europe/Amsterdam"
            - name: DNSMASQ_LISTENING
              value: "all"
          volumeMounts:
            - name: storage
              mountPath: "/etc/pihole"
              subPath: pihole
            - name: storage
              mountPath: "/etc/dnsmasq.d"
              subPath: dnsmasq.d
      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: pihole-pvc
